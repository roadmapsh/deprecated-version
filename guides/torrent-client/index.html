<!doctypehtml><html lang=en><meta charset=utf-8><title>Building a BitTorrent Client - roadmap.sh</title><meta content="Learn everything you need to know about BitTorrent by writing a client in Go" name=description><meta content="Kamran Ahmed" name=author><meta content="roadmap, developer roadmaps, developer roadmap, how to become a developer, frontend developer roadmap, frontend developer roadmap 2022, backend developer roadmap, backend developer roadmap 2022, sre roadmap, sre roadmap 2022, devops roadmap, devops roadmap 2022, android developer roadmap, android developer roadmap 2022, dba roadmap, dba roadmap 2022, blockchain developer roadmap, blockchain developer roadmap 2022, qa roadmap, qa roadmap 2022, qa engineer roadmap, qa engineer roadmap 2022, software architect roadmap, software architect roadmap 2022, asp.net core developer roadmap, asp.net core developer roadmap 2022, react developer roadmap, react developer roadmap 2022, angular developer roadmap, angular developer roadmap 2022, vue developer roadmap, vue developer roadmap 2022, node.js developer roadmap, node.js developer roadmap 2022, javascript developer roadmap, javascript developer roadmap 2022, python developer roadmap, python developer roadmap 2022, go developer roadmap, go developer roadmap 2022, java developer roadmap, java developer roadmap 2022, design system roadmap, design system roadmap 2022, software design roadmap, software design roadmap 2022" name=keywords><meta content=width=device-width,user-scalable=yes,initial-scale=1.0,maximum-scale=3.0,minimum-scale=1.0 name=viewport><meta content=en http-equiv=Content-Language><meta content="Building a BitTorrent Client - roadmap.sh" property=og:title><meta content="Learn everything you need to know about BitTorrent by writing a client in Go" property=og:description><meta content=https://roadmap.sh/assets/images/brand-square.png property=og:image><meta content=https://roadmap.sh property=og:url><meta content=website property=og:type><meta content=roadmap.sh property=og:site_name><meta content=https://facebook.com/kamranahmedse property=article:publisher><meta content="Kamran Ahmed" property=article:author><meta content=summary name=twitter:card><meta content=@kamranahmedse name=twitter:site><meta content="Building a BitTorrent Client - roadmap.sh" name=twitter:title><meta content="Learn everything you need to know about BitTorrent by writing a client in Go" name=twitter:description><meta content=https://roadmap.sh/brand-square.png name=twitter:image><meta content=roadmap.sh name=twitter:image:alt><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=black-translucent name=apple-mobile-web-app-status-bar-style><link href=/assets/manifest/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><meta content=#101010 name=msapplication-TileColor><meta content=#848a9a name=theme-color><link href=/assets/manifest/icon32.png rel=icon sizes=32x32 type=image/png><link href=/assets/manifest/icon16.png rel=icon sizes=16x16 type=image/png><link rel="shortcut icon" href=/assets/manifest/favicon.ico type=image/x-icon><link href=/assets/manifest/favicon.ico rel=icon type=image/x-icon><link href=/assets/manifest/manifest.json rel=manifest><link href=/styles/main.css rel=stylesheet><link href=/ rel=preconnect><meta content=noindex name=robots><style>div[class*="language-"],
code[class*='language-'],
pre[class*='language-'] {
  color: #9efeff;
  direction: ltr;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;

  font-family: 'Operator Mono', 'Fira Code', Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  font-weight: 400;
  font-size: .95rem;
  line-height: 1.3;

  letter-spacing: 0.5px;
  text-shadow: 0 1px #222245;

  margin-bottom: 25px !important;
}

pre[class*='language-']::-moz-selection,
pre[class*='language-'] ::-moz-selection,
code[class*='language-']::-moz-selection,
code[class*='language-'] ::-moz-selection,
pre[class*='language-']::selection,
pre[class*='language-'] ::selection,
code[class*='language-']::selection,
code[class*='language-'] ::selection {
  color: inherit;
  background: #a599e9;
}

code:not([class]) {
  padding: 2px 4px;
  font-family: 'Operator Mono', 'Fira Code', Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  font-size: .875rem;
  background-color: #FAFAFA;
  border: 1px solid #EAEAEA;
  border-radius: 4px;
}

/* Code blocks. */
pre[class*='language-'] {
  padding: 1em;
  border-radius: 4px;

  margin: 0.5em 0;
  overflow: auto;
}

:not(pre) > code[class*='language-'],
pre[class*='language-'] {
  background: #1e1e3f;
}

/* Inline code */
:not(pre) > code[class*='language-'] {
  padding: 0.1em;
  border-radius: 0.3em;
}

.token {
  font-weight: 400;
}

.token.comment,
.token.prolog,
.token.cdata {
  color: #b362ff;
}

.token.delimiter,
.token.keyword,
.token.selector,
.token.important,
.token.atrule {
  color: #ff9d00;
}

.token.operator,
.token.attr-name {
  color: rgb(255, 180, 84);
}

.token.punctuation {
  color: #ffffff;
}

.token.boolean {
  color: rgb(255, 98, 140);
}

.token.tag,
.token.tag .punctuation,
.token.doctype,
.token.builtin {
  color: rgb(255, 157, 0);
}

.token.entity,
.token.symbol {
  color: #6897bb;
}

.token.number {
  color: #ff628c;
}

.token.property,
.token.constant,
.token.variable {
  color: #ff628c;
}

.token.string,
.token.char {
  color: #a5ff90;
}

.token.attr-value,
.token.attr-value .punctuation {
  color: #a5c261;
}

.token.attr-value .punctuation:first-child {
  color: #a9b7c6;
}

.token.url {
  color: #287bde;
  text-decoration: underline;
}

.token.function {
  color: rgb(250, 208, 0);
}

.token.regex {
  background: #364135;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}

.token.inserted {
  background: #00ff00;
}

.token.deleted {
  background: #ff000d;
}

code.language-css .token.property,
code.language-css .token.property + .token.punctuation {
  color: #a9b7c6;
}

code.language-css .token.id {
  color: #ffc66d;
}

code.language-css .token.selector > .token.class,
code.language-css .token.selector > .token.attribute,
code.language-css .token.selector > .token.pseudo-class,
code.language-css .token.selector > .token.pseudo-element {
  color: #ffc66d;
}

.token.class-name {
  color: #fb94ff;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  background: none;
}

pre .line-highlight,
pre .line-highlight.line-highlight,
pre > code.line-highlight {
  margin-top: 36px;
  background: linear-gradient(to right, rgba(179, 98, 255, 0.17), transparent);
}

pre .line-highlight:before,
pre > code.line-highlight:before,
pre .line-highlight[data-end]:after,
pre > code.line-highlight[data-end]:after {
  content: '';
}</style><body class=relative><div class="sticky top-0 border-b border-b-yellow-300 z-10 flex h-[37px]" id=sticky-youtube-banner><a class="flex bg-yellow-200 text-center flex-1 items-center justify-center text-sm hover:bg-yellow-300 outline-0" href=https://youtube.com/theroadmap?sub_confirmation=1 target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=20 style=height:20px;display:inline-block;margin-right:7px width=20 xmlns=http://www.w3.org/2000/svg><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.488 3.45.029 5.804 0 12c.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"></path></svg> We now have a YouTube Channel.¬†<span class="hidden sm:inline">Subscribe for the video content.</span> </a><button class="text-yellow-500 bg-yellow-200 hover:text-yellow-900 hover:bg-yellow-400 outline-0 px-2" onclick=this.parentElement.classList.add("hidden")><svg class="w-5 h-5" viewbox="0 0 20 20" aria-hidden=true fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule=evenodd fill-rule=evenodd></path></svg></button></div><div class="bg-slate-900 text-white py-5 sm:py-8"><nav class="container flex items-center justify-between"><a class="font-medium text-lg flex items-center text-white hover:text-gray-400 transition-colors" href=/> <svg viewbox="0 0 283 283" fill=none height=30 width=30 xmlns=http://www.w3.org/2000/svg><path d="M0 39C0 17.46 17.46 0 39 0h205c21.539 0 39 17.46 39 39v205c0 21.539-17.461 39-39 39H39c-21.54 0-39-17.461-39-39V39Z" fill=currentColor></path><path d="M121.215 210.72c-1.867.56-4.854 1.12-8.96 1.68-3.92.56-8.027.84-12.32.84-4.107 0-7.84-.28-11.2-.84-3.174-.56-5.88-1.68-8.12-3.36-2.24-1.68-4.014-3.92-5.32-6.72-1.12-2.987-1.68-6.813-1.68-11.48v-84c0-4.293.746-7.933 2.24-10.92 1.68-3.173 4.013-5.973 7-8.4 2.986-2.427 6.626-4.573 10.92-6.44 4.48-2.053 9.24-3.827 14.28-5.32a106.176 106.176 0 0 1 15.68-3.36 95.412 95.412 0 0 1 16.24-1.4c8.96 0 16.053 1.773 21.28 5.32 5.226 3.36 7.84 8.96 7.84 16.8 0 2.613-.374 5.227-1.12 7.84-.747 2.427-1.68 4.667-2.8 6.72-3.92 0-7.934.187-12.04.56-4.107.373-8.12.933-12.04 1.68-3.92.747-7.654 1.587-11.2 2.52-3.36.747-6.254 1.68-8.68 2.8v95.48Zm45.172-22.4c0-7.84 2.426-14.373 7.28-19.6 4.853-5.227 11.48-7.84 19.88-7.84 8.4 0 15.026 2.613 19.88 7.84 4.853 5.227 7.28 11.76 7.28 19.6 0 7.84-2.427 14.373-7.28 19.6-4.854 5.227-11.48 7.84-19.88 7.84-8.4 0-15.027-2.613-19.88-7.84-4.854-5.227-7.28-11.76-7.28-19.6Z" fill=#000></path></svg> <span class=ml-3>roadmap.sh</span> </a><ul class="hidden sm:flex space-x-5"><li><a class="text-gray-400 hover:text-white transition-colors" href=/roadmaps>Roadmaps</a><li><a class="text-gray-400 hover:text-white transition-colors" href=/guides>Guides</a><li><a class="text-gray-400 hover:text-white transition-colors" href=/videos>Videos</a><li><a class="py-2 px-4 text-sm font-regular rounded-full bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white" href=/signup> Subscribe </a></ul><button class="text-gray-400 hover:text-gray-50 block sm:hidden cursor-pointer" aria-label=Menu id=show-mobile-navigation><svg class="h-5 w-5" viewbox="0 0 24 24" aria-hidden=true focusable=false><path d="M 3 5 A 1.0001 1.0001 0 1 0 3 7 L 21 7 A 1.0001 1.0001 0 1 0 21 5 L 3 5 z M 3 11 A 1.0001 1.0001 0 1 0 3 13 L 21 13 A 1.0001 1.0001 0 1 0 21 11 L 3 11 z M 3 17 A 1.0001 1.0001 0 1 0 3 19 L 21 19 A 1.0001 1.0001 0 1 0 21 17 L 3 17 z" fill=currentColor></path></svg></button><div class="fixed top-0 bottom-0 left-0 right-0 z-40 bg-slate-900 flex items-center hidden" id=mobile-navigation><button class="text-gray-400 hover:text-gray-50 block cursor-pointer absolute top-6 right-6 cursor-pointer" id=close-mobile-navigation><svg class="w-5 h-5" viewbox="0 0 20 20" aria-hidden=true fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule=evenodd fill-rule=evenodd></path></svg></button><ul class="flex flex-col gap-2 md:gap-3 items-center w-full"><li><a class="text-xl md:text-lg hover:text-blue-300" href=/roadmaps>Roadmaps</a><li><a class="text-xl md:text-lg hover:text-blue-300" href=/guides>Guides</a><li><a class="text-xl md:text-lg hover:text-blue-300" href=/videos>Videos</a><li><a class="text-xl md:text-lg text-red-300 hover:text-red-400" href=/signup>Subscribe</a></ul></div></nav></div><div class="bg-white border-b py-5 sm:py-12"><div class="container text-left sm:text-center"><p class="text-gray-400 hidden sm:flex items-center justify-start sm:justify-center"><a class="font-medium hover:text-gray-600 inline-flex items-center hover:underline" href=https://twitter.com/__jesse_li target=_blank> <img class="w-5 h-5 inline mr-2 rounded-full" src=/assets/authors/jesse.png> Jesse Li </a> <span class=mx-1.5>¬∑</span> <span class=capitalize>textual Guide</span> <span class=mx-1.5>¬∑</span> <a class="text-blue-400 hover:text-blue-500 hover:underline" href=https://github.com/kamranahmedse/roadmap.sh/tree/master/src/guides/torrent-client.md target=_blank>Improve this Guide</a><h1 class="text-2xl sm:text-5xl my-0 sm:my-3.5 font-bold">Building a BitTorrent Client</h1><p class="hidden sm:block text-gray-400 text-md">Learn everything you need to know about BitTorrent by writing a client in Go</div></div><div class="bg-gray-50 py-5 sm:py-10"><div class=container><main id=main-content><p class=mb-4>BitTorrent is a protocol for downloading and distributing files across the Internet. In contrast with the traditional client/server relationship, in which downloaders connect to a central server (for example: watching a movie on Netflix, or loading the web page you‚Äôre reading now), participants in the BitTorrent network, called <strong>peers</strong>, download pieces of files from <em>each other</em>‚Äîthis is what makes it a <strong>peer-to-peer</strong> protocol. In this article we will investigate how this works, and build our own client that can find peers and exchange data between them.<p class=mb-4><img alt="diagram showing the difference between client/server (all clients connecting to one server) and peer-to-peer (peers connecting to each other) relationships" src=/assets/guides/torrent-client/client-server-p2p.png><p class=mb-4>The protocol evolved organically over the past 20 years, and various people and organizations added extensions for features like encryption, private torrents, and new ways of finding peers. We‚Äôll be implementing the <a class="font-bold underline" href=https://www.bittorrent.org/beps/bep_0003.html>original spec</a> from 2001 to keep this a weekend-sized project.<p class=mb-4>I‚Äôll be using a <a class="font-bold underline" href=https://cdimage.debian.org/debian-cd/current/amd64/bt-cd/#indexlist>Debian ISO</a> file as my guinea pig because it‚Äôs big, but not huge, at 350MB. As a popular Linux distribution, there will be lots of fast and cooperative peers for us to connect to. And we‚Äôll avoid the legal and ethical issues related to downloading pirated content.<h2 class="text-xl sm:text-3xl font-bold mb-2 mt-7" id=finding-peers tabindex=-1>Finding peers</h2><p class=mb-4>Here‚Äôs a problem: we want to download a file with BitTorrent, but it‚Äôs a peer-to-peer protocol and we have no idea where to find peers to download it from. This is a lot like moving to a new city and trying to make friends‚Äîmaybe we‚Äôll hit up a local pub or a meetup group! Centralized locations like these are the big idea behind trackers, which are central servers that introduce peers to each other. They‚Äôre just web servers running over HTTP, and you can find Debian‚Äôs at <a class="font-bold underline" href=http://bttracker.debian.org:6969/>http://bttracker.debian.org:6969/</a><p class=mb-4><img alt="illustration of a desktop computer and laptop sitting at a pub" src=/assets/guides/torrent-client/trackers.png><p class=mb-4>Of course, these central servers are liable to get raided by the feds if they facilitate peers exchanging illegal content. You may remember reading about trackers like TorrentSpy, Popcorn Time, and KickassTorrents getting seized and shut down. New methods cut out the middleman by making even <strong>peer discovery</strong> a distributed process. We won‚Äôt be implementing them, but if you‚Äôre interested, some terms you can research are <strong>DHT</strong>, <strong>PEX</strong>, and <strong>magnet links</strong>.<h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=parsing-a-.torrent-file tabindex=-1>Parsing a .torrent file</h3><p class=mb-4>A .torrent file describes the contents of a torrentable file and information for connecting to a tracker. It‚Äôs all we need in order to kickstart the process of downloading a torrent. Debian‚Äôs .torrent file looks like this:<pre class=language-markdown><code class=language-markdown>d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:"Debian CD from cdimage.debian.org"13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:ÔøΩÔøΩÔøΩÔøΩÔøΩPSÔøΩ^ÔøΩÔøΩ (binary blob of the hashes of each piece)ee</code></pre><p class=mb-4>That mess is encoded in a format called <strong>Bencode</strong> (pronounced <em>bee-encode</em>), and we‚Äôll need to decode it.<p class=mb-4>Bencode can encode roughly the same types of structures as JSON‚Äîstrings, integers, lists, and dictionaries. Bencoded data is not as human-readable/writable as JSON, but it can efficiently handle binary data and it‚Äôs really simple to parse from a stream. Strings come with a length prefix, and look like <code>4:spam</code>. Integers go between <em>start</em> and <em>end</em> markers, so <code>7</code> would encode to <code>i7e</code>. Lists and dictionaries work in a similar way: <code>l4:spami7ee</code> represents <code>['spam', 7]</code>, while <code>d4:spami7ee</code> means <code>{spam: 7}</code>.<p class=mb-4>In a prettier format, our .torrent file looks like this:<pre class=language-markdown><code class=language-markdown>d<br>  8:announce<br>    41:http://bttracker.debian.org:6969/announce<br>  7:comment<br>    35:"Debian CD from cdimage.debian.org"<br>  13:creation date<br>    i1573903810e<br>  4:info<br>    d<br>      6:length<br>        i351272960e<br>      4:name<br>        31:debian-10.2.0-amd64-netinst.iso<br>      12:piece length<br>        i262144e<br>      6:pieces<br>        26800:ÔøΩÔøΩÔøΩÔøΩÔøΩPSÔøΩ^ÔøΩÔøΩ (binary blob of the hashes of each piece)<br>    e<br>e</code></pre><p class=mb-4>In this file, we can spot the URL of the tracker, the creation date (as a Unix timestamp), the name and size of the file, and a big binary blob containing the SHA-1 hashes of each <strong>piece</strong>, which are equally-sized parts of the file we want to download. The exact size of a piece varies between torrents, but they are usually somewhere between 256KB and 1MB. This means that a large file might be made up of <em>thousands</em> of pieces. We‚Äôll download these pieces from our peers, check them against the hashes from our torrent file, assemble them together, and boom, we‚Äôve got a file!<p class=mb-4><img alt='"illustration of a file being cut with scissors into multiple pieces, starting with piece 0' src=/assets/guides/torrent-client/pieces.png><p class=mb-4>This mechanism allows us to verify the integrity of each piece as we go. It makes BitTorrent resistant to accidental corruption or intentional <strong>torrent poisoning</strong>. Unless an attacker is capable of breaking SHA-1 with a preimage attack, we will get exactly the content we asked for.<p class=mb-4>It would be really fun to write a bencode parser, but parsing isn‚Äôt our focus today. But I found Fredrik Lundh‚Äôs <a class="font-bold underline" href=https://effbot.org/zone/bencode.htm>50 line parser</a> to be especially illuminating. For this project, I used <a class="font-bold underline" href=https://github.com/jackpal/bencode-go>github.com/jackpal/bencode-go</a>:<pre class=language-go><code class=language-go><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"github.com/jackpal/bencode-go"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">type</span> bencodeInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Pieces      <span class="token builtin">string</span> <span class="token string">`bencode:"pieces"`</span><br>    PieceLength <span class="token builtin">int</span>    <span class="token string">`bencode:"piece length"`</span><br>    Length      <span class="token builtin">int</span>    <span class="token string">`bencode:"length"`</span><br>    Name        <span class="token builtin">string</span> <span class="token string">`bencode:"name"`</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> bencodeTorrent <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Announce <span class="token builtin">string</span>      <span class="token string">`bencode:"announce"`</span><br>    Info     bencodeInfo <span class="token string">`bencode:"info"`</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Open parses a torrent file</span><br><span class="token keyword">func</span> <span class="token function">Open</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>bencodeTorrent<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    bto <span class="token operator">:=</span> bencodeTorrent<span class="token punctuation">{</span><span class="token punctuation">}</span><br>    err <span class="token operator">:=</span> bencode<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token operator">&</span>bto<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token operator">&</span>bto<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p class=mb-4>Because I like to keep my structures relatively flat, and I like to keep my application structs separate from my serialization structs, I exported a different, flatter struct named <code>TorrentFile</code> and wrote a few helper functions to convert between the two.<p class=mb-4>Notably, I split <code>pieces</code> (previously a string) into a slice of hashes (each <code>[20]byte</code>) so that I can easily access individual hashes later. I also computed the SHA-1 hash of the entire bencoded <code>info</code> dict (the one which contained the name, size, and piece hashes). We know this as the <strong>infohash</strong> and it uniquely identifies files when we talk to trackers and peers. More on this later.<p class=mb-4><img alt="a name tag saying 'Hello my name is 86d4c80024a469be4c50bc5a102cf71780310074'" src=/assets/guides/torrent-client/info-hash.png><pre class=language-go><code class=language-go><span class="token keyword">type</span> TorrentFile <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Announce    <span class="token builtin">string</span><br>    InfoHash    <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br>    PieceHashes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br>    PieceLength <span class="token builtin">int</span><br>    Length      <span class="token builtin">int</span><br>    Name        <span class="token builtin">string</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>bto <span class="token operator">*</span>bencodeTorrent<span class="token punctuation">)</span> <span class="token function">toTorrentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TorrentFile<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre><h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=retrieving-peers-from-the-tracker tabindex=-1>Retrieving peers from the tracker</h3><p class=mb-4>Now that we have information about the file and its tracker, let‚Äôs talk to the tracker to <strong>announce</strong> our presence as a peer and to retrieve a list of other peers. We just need to make a GET request to the <code>announce</code> URL supplied in the .torrent file, with a few query parameters:<pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>TorrentFile<span class="token punctuation">)</span> <span class="token function">buildTrackerURL</span><span class="token punctuation">(</span>peerID <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> port <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    base<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Announce<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br>    params <span class="token operator">:=</span> url<span class="token punctuation">.</span>Values<span class="token punctuation">{</span><br>        <span class="token string">"info_hash"</span><span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token function">string</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>InfoHash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"peer_id"</span><span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token function">string</span><span class="token punctuation">(</span>peerID<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"port"</span><span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>Port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"uploaded"</span><span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"0"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"downloaded"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"0"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"compact"</span><span class="token punctuation">:</span>    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token string">"left"</span><span class="token punctuation">:</span>       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br>    base<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> base<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><p class=mb-4>The important ones:<ul class="mb-5 ml-7 list-disc"><li class=mb-1><strong>info_hash</strong>: Identifies the <em>file</em> we‚Äôre trying to download. It‚Äôs the infohash we calculated earlier from the bencoded <code>info</code> dict. The tracker will use this to figure out which peers to show us.<li class=mb-1><strong>peer_id</strong>: A 20 byte name to identify <em>ourselves</em> to trackers and peers. We‚Äôll just generate 20 random bytes for this. Real BitTorrent clients have IDs like <code>-TR2940-k8hj0wgej6ch</code> which identify the client software and version‚Äîin this case, TR2940 stands for Transmission client 2.94.</ul><p class=mb-4><img alt="a file with a name tag saying 'info_hash' and a person with a name tag 'peer_id'" src=/assets/guides/torrent-client/info-hash-peer-id.png><h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=parsing-the-tracker-response tabindex=-1>Parsing the tracker response</h3><p class=mb-4>We get back a bencoded response:<pre class=language-markdown><code class=language-markdown>d<br>  8:interval<br>    i900e<br>  5:peers<br>    252:(another long binary blob)<br>e</code></pre><p class=mb-4><code>Interval</code> tells us how often we‚Äôre supposed to connect to the tracker again to refresh our list of peers. A value of 900 means we should reconnect every 15 minutes (900 seconds).<p class=mb-4><code>Peers</code> is another long binary blob containing the IP addresses of each peer. It‚Äôs made out of <strong>groups of six bytes</strong>. The first four bytes in each group represent the peer‚Äôs IP address‚Äîeach byte represents a number in the IP. The last two bytes represent the port, as a big-endian <code>uint16</code>. <strong>Big-endian</strong>, or <strong>network order</strong>, means that we can interpret a group of bytes as an integer by just squishing them together left to right. For example, the bytes <code>0x1A</code>, <code>0xE1</code> make <code>0x1AE1</code>, or 6881 in decimal.<p class=mb-4><img alt="diagram showing how 192, 0, 2, 123, 0x1A, 0xE1 can be interpreted as 192.0.1.123:6881" src=/assets/guides/torrent-client/address.png><pre class=language-go><code class=language-go><span class="token comment">// Peer encodes connection information for a peer</span><br><span class="token keyword">type</span> Peer <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    IP   net<span class="token punctuation">.</span>IP<br>    Port <span class="token builtin">uint16</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Unmarshal parses peer IP addresses and ports from a buffer</span><br><span class="token keyword">func</span> <span class="token function">Unmarshal</span><span class="token punctuation">(</span>peersBin <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Peer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> peerSize <span class="token operator">=</span> <span class="token number">6</span> <span class="token comment">// 4 for IP, 2 for port</span><br>    numPeers <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>peersBin<span class="token punctuation">)</span> <span class="token operator">/</span> peerSize<br>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>peersBin<span class="token punctuation">)</span><span class="token operator">%</span>peerSize <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>        err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Received malformed peers"</span><span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br>    peers <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Peer<span class="token punctuation">,</span> numPeers<span class="token punctuation">)</span><br>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator"><</span> numPeers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>        offset <span class="token operator">:=</span> i <span class="token operator">*</span> peerSize<br>        peers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>IP <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span>peersBin<span class="token punctuation">[</span>offset <span class="token punctuation">:</span> offset<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>        peers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Port <span class="token operator">=</span> binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">Uint16</span><span class="token punctuation">(</span>peersBin<span class="token punctuation">[</span>offset<span class="token operator">+</span><span class="token number">4</span> <span class="token punctuation">:</span> offset<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> peers<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><h2 class="text-xl sm:text-3xl font-bold mb-2 mt-7" id=downloading-from-peers tabindex=-1>Downloading from peers</h2><p class=mb-4>Now that we have a list of peers, it‚Äôs time to connect with them and start downloading pieces! We can break down the process into a few steps. For each peer, we want to:<ol><li class=mb-1>Start a TCP connection with the peer. This is like starting a phone call.<li class=mb-1>Complete a two-way BitTorrent <strong>handshake</strong>. <em>‚ÄúHello?‚Äù ‚ÄúHello.‚Äù</em><li class=mb-1>Exchange <strong>messages</strong> to download <strong>pieces</strong>. <em>‚ÄúI‚Äôd like piece #231 please.‚Äù</em></ol><h2 class="text-xl sm:text-3xl font-bold mb-2 mt-7" id=start-a-tcp-connection tabindex=-1>Start a TCP connection</h2><pre class=language-go><code class=language-go>conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">DialTimeout</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><br><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br><span class="token punctuation">}</span></code></pre><p class=mb-4>I set a timeout so that I don‚Äôt waste too much time on peers that aren‚Äôt going to let me connect. For the most part, it‚Äôs a pretty standard TCP connection.<h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=complete-the-handshake tabindex=-1>Complete the handshake</h3><p class=mb-4>We‚Äôve just set up a connection with a peer, but we want do a handshake to validate our assumptions that the peer<ul class="mb-5 ml-7 list-disc"><li class=mb-1>can communicate using the BitTorrent protocol<li class=mb-1>is able to understand and respond to our messages<li class=mb-1>has the file that we want, or at least knows what we‚Äôre talking about</ul><p class=mb-4><img alt="Two computers communicating. One asks 'do you speak BitTorrent and have this file?' and the other replies 'I speak BitTorrent and have that file'" src=/assets/guides/torrent-client/handshake.png><p class=mb-4>My father told me that the secret to a good handshake is a firm grip and eye contact. The secret to a good BitTorrent handshake is that it‚Äôs made up of five parts:<ol><li class=mb-1>The length of the protocol identifier, which is always 19 (0x13 in hex)<li class=mb-1>The protocol identifier, called the <strong>pstr</strong> which is always <code>BitTorrent protocol</code><li class=mb-1>Eight <strong>reserved bytes</strong>, all set to 0. We‚Äôd flip some of them to 1 to indicate that we support certain <a class="font-bold underline" href=http://www.bittorrent.org/beps/bep_0010.html>extensions</a>. But we don‚Äôt, so we‚Äôll keep them at 0.<li class=mb-1>The <strong>infohash</strong> that we calculated earlier to identify which file we want<li class=mb-1>The <strong>Peer ID</strong> that we made up to identify ourselves</ol><p class=mb-4>Put together, a handshake string might look like this:<pre class=language-markdown><code class=language-markdown>\x13BitTorrent protocol\x00\x00\x00\x00\x00\x00\x00\x00\x86\xd4\xc8\x00\x24\xa4\x69\xbe\x4c\x50\xbc\x5a\x10\x2c\xf7\x17\x80\x31\x00\x74-TR2940-k8hj0wgej6ch</code></pre><p class=mb-4>After we send a handshake to our peer, we should receive a handshake back in the same format. The infohash we get back should match the one we sent so that we know that we‚Äôre talking about the same file. If everything goes as planned, we‚Äôre good to go. If not, we can sever the connection because there‚Äôs something wrong. <em>‚ÄúHello?‚Äù ‚ÄúËøôÊòØË∞ÅÔºü ‰Ω†ÊÉ≥Ë¶Å‰ªÄ‰πàÔºü‚Äù ‚ÄúOkay, wow, wrong number.‚Äù</em><p class=mb-4>In our code, let‚Äôs make a struct to represent a handshake, and write a few methods for serializing and reading them:<pre class=language-go><code class=language-go><span class="token comment">// A Handshake is a special message that a peer uses to identify itself</span><br><span class="token keyword">type</span> Handshake <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    Pstr     <span class="token builtin">string</span><br>    InfoHash <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br>    PeerID   <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Serialize serializes the handshake to a buffer</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Handshake<span class="token punctuation">)</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span><br>    buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Pstr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">49</span><span class="token punctuation">)</span><br>    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">byte</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>Pstr<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    curr <span class="token operator">:=</span> <span class="token number">1</span><br>    curr <span class="token operator">+=</span> <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>curr<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>Pstr<span class="token punctuation">)</span><br>    curr <span class="token operator">+=</span> <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>curr<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 8 reserved bytes</span><br>    curr <span class="token operator">+=</span> <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>curr<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>InfoHash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    curr <span class="token operator">+=</span> <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>curr<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>PeerID<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token keyword">return</span> buf<br><span class="token punctuation">}</span><br><br><span class="token comment">// Read parses a handshake from a stream</span><br><span class="token keyword">func</span> <span class="token function">Read</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Handshake<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Do Serialize(), but backwards</span><br>    <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre><h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=send-and-receive-messages tabindex=-1>Send and receive messages</h3><p class=mb-4>Once we‚Äôve completed the initial handshake, we can send and receive <strong>messages</strong>. Well, not quite‚Äîif the other peer isn‚Äôt ready to accept messages, we can‚Äôt send any until they tell us they‚Äôre ready. In this state, we‚Äôre considered <strong>choked</strong> by the other peer. They‚Äôll send us an <strong>unchoke</strong> message to let us know that we can begin asking them for data. By default, we assume that we‚Äôre choked until proven otherwise.<p class=mb-4>Once we‚Äôve been unchoked, we can then begin sending <strong>requests</strong> for pieces, and they can send us messages back containing pieces.<p class=mb-4><img alt="&#34A cartoon in which person 1 says 'hello I would like piece number‚Äî' and person 2 grabs him by the neck and says '00 00 00 01 00 (choke)'" src=/assets/guides/torrent-client/choke.png><h4>Interpreting messages</h4><p class=mb-4>A message has a length, an <strong>ID</strong> and a <strong>payload</strong>. On the wire, it looks like:<p class=mb-4><img alt="A message with 4 byte for the length, 1 byte for ID, and an optional payload" src=/assets/guides/torrent-client/message.png><p class=mb-4>A message starts with a length indicator which tells us how many bytes long the message will be. It‚Äôs a 32-bit integer, meaning it‚Äôs made out of four bytes smooshed together in big-endian order. The next byte, the <strong>ID</strong>, tells us which type of message we‚Äôre receiving‚Äîfor example, a <code>2</code> byte means ‚Äúinterested.‚Äù Finally, the optional <strong>payload</strong> fills out the remaining length of the message.<pre class=language-go><code class=language-go><span class="token keyword">type</span> messageID <span class="token builtin">uint8</span><br><br><span class="token keyword">const</span> <span class="token punctuation">(</span><br>    MsgChoke         messageID <span class="token operator">=</span> <span class="token number">0</span><br>    MsgUnchoke       messageID <span class="token operator">=</span> <span class="token number">1</span><br>    MsgInterested    messageID <span class="token operator">=</span> <span class="token number">2</span><br>    MsgNotInterested messageID <span class="token operator">=</span> <span class="token number">3</span><br>    MsgHave          messageID <span class="token operator">=</span> <span class="token number">4</span><br>    MsgBitfield      messageID <span class="token operator">=</span> <span class="token number">5</span><br>    MsgRequest       messageID <span class="token operator">=</span> <span class="token number">6</span><br>    MsgPiece         messageID <span class="token operator">=</span> <span class="token number">7</span><br>    MsgCancel        messageID <span class="token operator">=</span> <span class="token number">8</span><br><span class="token punctuation">)</span><br><br><span class="token comment">// Message stores ID and payload of a message</span><br><span class="token keyword">type</span> Message <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    ID      messageID<br>    Payload <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Serialize serializes a message into a buffer of the form</span><br><span class="token comment">// &LTlength prefix>&LTmessage ID>&LTpayload></span><br><span class="token comment">// Interprets `nil` as a keep-alive message</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Message<span class="token punctuation">)</span> <span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> m <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    length <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// +1 for id</span><br>    buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">+</span>length<span class="token punctuation">)</span><br>    binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><br>    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">byte</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><br>    <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span><br>    <span class="token keyword">return</span> buf<br><span class="token punctuation">}</span></code></pre><p class=mb-4>To read a message from a stream, we just follow the format of a message. We read four bytes and interpret them as a <code>uint32</code> to get the <strong>length</strong> of the message. Then, we read that number of bytes to get the <strong>ID</strong> (the first byte) and the <strong>payload</strong> (the remaining bytes).<pre class=language-go><code class=language-go><span class="token comment">// Read parses a message from a stream. Returns `nil` on keep-alive message</span><br><span class="token keyword">func</span> <span class="token function">Read</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Message<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    lengthBuf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><br>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> lengthBuf<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br>    length <span class="token operator">:=</span> binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>lengthBuf<span class="token punctuation">)</span><br><br>    <span class="token comment">// keep-alive message</span><br>    <span class="token keyword">if</span> length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><br>    <span class="token punctuation">}</span><br><br>    messageBuf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><br>    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> messageBuf<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>    <span class="token punctuation">}</span><br><br>    m <span class="token operator">:=</span> Message<span class="token punctuation">{</span><br>        ID<span class="token punctuation">:</span>      <span class="token function">messageID</span><span class="token punctuation">(</span>messageBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        Payload<span class="token punctuation">:</span> messageBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> <span class="token operator">&</span>m<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><h4>Bitfields</h4><p class=mb-4>One of the most interesting types of message is the <strong>bitfield</strong>, which is a data structure that peers use to efficiently encode which pieces they are able to send us. A bitfield looks like a byte array, and to check which pieces they have, we just need to look at the positions of the <em>bits</em> set to 1. You can think of it like the digital equivalent of a coffee shop loyalty card. We start with a blank card of all <code>0</code>, and flip bits to <code>1</code> to mark their positions as ‚Äústamped.‚Äù<p class=mb-4><img alt="a coffee shop loyalty card with eight slots, with stamps on the first four slots and a stamp on the second to last slot, represented as 11110010" src=/assets/guides/torrent-client/bitfield.png><p class=mb-4>By working with <em>bits</em> instead of <em>bytes</em>, this data structure is super compact. We can stuff information about eight pieces in the space of a single byte‚Äîthe size of a <code>bool</code>. The tradeoff is that accessing values becomes a little more tricky. The smallest unit of memory that computers can address are bytes, so to get to our bits, we have to do some bitwise manipulation:<pre class=language-go><code class=language-go><span class="token comment">// A Bitfield represents the pieces that a peer has</span><br><span class="token keyword">type</span> Bitfield <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br><br><span class="token comment">// HasPiece tells if a bitfield has a particular index set</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>bf Bitfield<span class="token punctuation">)</span> <span class="token function">HasPiece</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span><br>    byteIndex <span class="token operator">:=</span> index <span class="token operator">/</span> <span class="token number">8</span><br>    offset <span class="token operator">:=</span> index <span class="token operator">%</span> <span class="token number">8</span><br>    <span class="token keyword">return</span> bf<span class="token punctuation">[</span>byteIndex<span class="token punctuation">]</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span>offset<span class="token punctuation">)</span><span class="token operator">&</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token number">0</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// SetPiece sets a bit in the bitfield</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>bf Bitfield<span class="token punctuation">)</span> <span class="token function">SetPiece</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    byteIndex <span class="token operator">:=</span> index <span class="token operator">/</span> <span class="token number">8</span><br>    offset <span class="token operator">:=</span> index <span class="token operator">%</span> <span class="token number">8</span><br>    bf<span class="token punctuation">[</span>byteIndex<span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator"><<</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">-</span> offset<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><h3 class="text-lg sm:text-2xl font-bold mb-0 mt-3" id=putting-it-all-together tabindex=-1>Putting it all together</h3><p class=mb-4>We now have all the tools we need to download a torrent: we have a list of peers obtained from the tracker, and we can communicate with them by dialing a TCP connection, initiating a handshake, and sending and receiving messages. Our last big problems are handling the <strong>concurrency</strong> involved in talking to multiple peers at once, and managing the <strong>state</strong> of our peers as we interact with them. These are both classically Hard problems.<h4>Managing concurrency: channels as queues</h4><p class=mb-4>In Go, we <a class="font-bold underline" href=https://blog.golang.org/share-memory-by-communicating>share memory by communicating</a>, and we can think of a Go channel as a cheap thread-safe queue.<p class=mb-4>We‚Äôll set up two channels to synchronize our concurrent workers: one for dishing out work (pieces to download) between peers, and another for collecting downloaded pieces. As downloaded pieces come in through the results channel, we can copy them into a buffer to start assembling our complete file.<pre class=language-go><code class=language-go><span class="token comment">// Init queues for workers to retrieve work and send results</span><br>workQueue <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>pieceWork<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>PieceHashes<span class="token punctuation">)</span><span class="token punctuation">)</span><br>results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>pieceResult<span class="token punctuation">)</span><br><span class="token keyword">for</span> index<span class="token punctuation">,</span> hash <span class="token operator">:=</span> <span class="token keyword">range</span> t<span class="token punctuation">.</span>PieceHashes <span class="token punctuation">{</span><br>    length <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">calculatePieceSize</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><br>    workQueue <span class="token operator">&LT-</span> <span class="token operator">&</span>pieceWork<span class="token punctuation">{</span>index<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> length<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Start workers</span><br><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> t<span class="token punctuation">.</span>Peers <span class="token punctuation">{</span><br>    <span class="token keyword">go</span> t<span class="token punctuation">.</span><span class="token function">startDownloadWorker</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> workQueue<span class="token punctuation">,</span> results<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// Collect results into a buffer until full</span><br>buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><br>donePieces <span class="token operator">:=</span> <span class="token number">0</span><br><span class="token keyword">for</span> donePieces <span class="token operator"><</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>PieceHashes<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res <span class="token operator">:=</span> <span class="token operator">&LT-</span>results<br>    begin<span class="token punctuation">,</span> end <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">calculateBoundsForPiece</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>index<span class="token punctuation">)</span><br>    <span class="token function">copy</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span>begin<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>buf<span class="token punctuation">)</span><br>    donePieces<span class="token operator">++</span><br><span class="token punctuation">}</span><br><span class="token function">close</span><span class="token punctuation">(</span>workQueue<span class="token punctuation">)</span></code></pre><p class=mb-4>We‚Äôll spawn a worker goroutine for each peer we‚Äôve received from the tracker. It‚Äôll connect and handshake with the peer, and then start retrieving work from the <code>workQueue</code>, attempting to download it, and sending downloaded pieces back through the <code>results</code> channel.<p class=mb-4><img alt="a flow chart of the download strategy" src=/assets/guides/torrent-client/download.png><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Torrent<span class="token punctuation">)</span> <span class="token function">startDownloadWorker</span><span class="token punctuation">(</span>peer peers<span class="token punctuation">.</span>Peer<span class="token punctuation">,</span> workQueue <span class="token keyword">chan</span> <span class="token operator">*</span>pieceWork<span class="token punctuation">,</span> results <span class="token keyword">chan</span> <span class="token operator">*</span>pieceResult<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    c<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> t<span class="token punctuation">.</span>PeerID<span class="token punctuation">,</span> t<span class="token punctuation">.</span>InfoHash<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Could not handshake with %s. Disconnecting\n"</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span>IP<span class="token punctuation">)</span><br>        <span class="token keyword">return</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Completed handshake with %s\n"</span><span class="token punctuation">,</span> peer<span class="token punctuation">.</span>IP<span class="token punctuation">)</span><br><br>    c<span class="token punctuation">.</span><span class="token function">SendUnchoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    c<span class="token punctuation">.</span><span class="token function">SendInterested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>    <span class="token keyword">for</span> pw <span class="token operator">:=</span> <span class="token keyword">range</span> workQueue <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>Bitfield<span class="token punctuation">.</span><span class="token function">HasPiece</span><span class="token punctuation">(</span>pw<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            workQueue <span class="token operator">&LT-</span> pw <span class="token comment">// Put piece back on the queue</span><br>            <span class="token keyword">continue</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// Download the piece</span><br>        buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">attemptDownloadPiece</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> pw<span class="token punctuation">)</span><br>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>            log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Exiting"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>            workQueue <span class="token operator">&LT-</span> pw <span class="token comment">// Put piece back on the queue</span><br>            <span class="token keyword">return</span><br>        <span class="token punctuation">}</span><br><br>        err <span class="token operator">=</span> <span class="token function">checkIntegrity</span><span class="token punctuation">(</span>pw<span class="token punctuation">,</span> buf<span class="token punctuation">)</span><br>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Piece #%d failed integrity check\n"</span><span class="token punctuation">,</span> pw<span class="token punctuation">.</span>index<span class="token punctuation">)</span><br>            workQueue <span class="token operator">&LT-</span> pw <span class="token comment">// Put piece back on the queue</span><br>            <span class="token keyword">continue</span><br>        <span class="token punctuation">}</span><br><br>        c<span class="token punctuation">.</span><span class="token function">SendHave</span><span class="token punctuation">(</span>pw<span class="token punctuation">.</span>index<span class="token punctuation">)</span><br>        results <span class="token operator">&LT-</span> <span class="token operator">&</span>pieceResult<span class="token punctuation">{</span>pw<span class="token punctuation">.</span>index<span class="token punctuation">,</span> buf<span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h4>Managing state</h4><p class=mb-4>We‚Äôll keep track of each peer in a struct, and modify that struct as we read messages. It‚Äôll include data like how much we‚Äôve downloaded from the peer, how much we‚Äôve requested from them, and whether we‚Äôre choked. If we wanted to scale this further, we could formalize this as a finite state machine. But a struct and a switch are good enough for now.<pre class=language-go><code class=language-go><span class="token keyword">type</span> pieceProgress <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>    index      <span class="token builtin">int</span><br>    client     <span class="token operator">*</span>client<span class="token punctuation">.</span>Client<br>    buf        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><br>    downloaded <span class="token builtin">int</span><br>    requested  <span class="token builtin">int</span><br>    backlog    <span class="token builtin">int</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>pieceProgress<span class="token punctuation">)</span> <span class="token function">readMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>    msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> state<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// this call blocks</span><br>    <span class="token keyword">switch</span> msg<span class="token punctuation">.</span>ID <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> message<span class="token punctuation">.</span>MsgUnchoke<span class="token punctuation">:</span><br>        state<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Choked <span class="token operator">=</span> <span class="token boolean">false</span><br>    <span class="token keyword">case</span> message<span class="token punctuation">.</span>MsgChoke<span class="token punctuation">:</span><br>        state<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Choked <span class="token operator">=</span> <span class="token boolean">true</span><br>    <span class="token keyword">case</span> message<span class="token punctuation">.</span>MsgHave<span class="token punctuation">:</span><br>        index<span class="token punctuation">,</span> err <span class="token operator">:=</span> message<span class="token punctuation">.</span><span class="token function">ParseHave</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><br>        state<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Bitfield<span class="token punctuation">.</span><span class="token function">SetPiece</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><br>    <span class="token keyword">case</span> message<span class="token punctuation">.</span>MsgPiece<span class="token punctuation">:</span><br>        n<span class="token punctuation">,</span> err <span class="token operator">:=</span> message<span class="token punctuation">.</span><span class="token function">ParsePiece</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>index<span class="token punctuation">,</span> state<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><br>        state<span class="token punctuation">.</span>downloaded <span class="token operator">+=</span> n<br>        state<span class="token punctuation">.</span>backlog<span class="token operator">--</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><h4>Time to make requests!</h4><p class=mb-4>Files, pieces, and piece hashes aren‚Äôt the full story‚Äîwe can go further by breaking down pieces into <strong>blocks</strong>. A block is a part of a piece, and we can fully define a block by the <strong>index</strong> of the piece it‚Äôs part of, its byte <strong>offset</strong> within the piece, and its <strong>length</strong>. When we make requests for data from peers, we are actually requesting <em>blocks</em>. A block is usually 16KB large, meaning that a single 256 KB piece might actually require 16 requests.<p class=mb-4>A peer is supposed to sever the connection if they receive a request for a block larger than 16KB. However, based on my experience, they‚Äôre often perfectly happy to satisfy requests up to 128KB. I only got moderate gains in overall speed with larger block sizes, so it‚Äôs probably better to stick with the spec.<h4>Pipelining</h4><p class=mb-4>Network round-trips are expensive, and requesting each block one by one will absolutely thank the performance of our download. Therefore, it‚Äôs important to <strong>pipeline</strong> our requests such that we keep up a constant pressure of some number of unfulfilled requests. This can increase the throughput of our connection by an order of magnitude.<p class=mb-4><img alt="Two email threads simulating peer connections. The thread on the left shows a request followed by a reply, repeated three times. The thread on the left sends three requests, and receives three replies in quick succession." src=/assets/guides/torrent-client/pipelining.png><p class=mb-4>Classically, BitTorrent clients kept a queue of five pipelined requests, and that‚Äôs the value I‚Äôll be using. I found that increasing it can up to double the speed of a download. Newer clients use an <a class="font-bold underline" href=https://luminarys.com/posts/writing-a-bittorrent-client.html>adaptive</a> queue size to better accommodate modern network speeds and conditions. This is definitely a parameter worth tweaking, and it‚Äôs pretty low hanging fruit for future performance optimization.<pre class=language-go><code class=language-go><span class="token comment">// MaxBlockSize is the largest number of bytes a request can ask for</span><br><span class="token keyword">const</span> MaxBlockSize <span class="token operator">=</span> <span class="token number">16384</span><br><br><span class="token comment">// MaxBacklog is the number of unfulfilled requests a client can have in its pipeline</span><br><span class="token keyword">const</span> MaxBacklog <span class="token operator">=</span> <span class="token number">5</span><br><br><span class="token keyword">func</span> <span class="token function">attemptDownloadPiece</span><span class="token punctuation">(</span>c <span class="token operator">*</span>client<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> pw <span class="token operator">*</span>pieceWork<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    state <span class="token operator">:=</span> pieceProgress<span class="token punctuation">{</span><br>        index<span class="token punctuation">:</span>  pw<span class="token punctuation">.</span>index<span class="token punctuation">,</span><br>        client<span class="token punctuation">:</span> c<span class="token punctuation">,</span><br>        buf<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> pw<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Setting a deadline helps get unresponsive peers unstuck.</span><br>    <span class="token comment">// 30 seconds is more than enough time to download a 262 KB piece</span><br>    c<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span><span class="token function">SetDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>Conn<span class="token punctuation">.</span><span class="token function">SetDeadline</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// Disable the deadline</span><br><br>    <span class="token keyword">for</span> state<span class="token punctuation">.</span>downloaded <span class="token operator"><</span> pw<span class="token punctuation">.</span>length <span class="token punctuation">{</span><br>        <span class="token comment">// If unchoked, send requests until we have enough unfulfilled requests</span><br>        <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Choked <span class="token punctuation">{</span><br>            <span class="token keyword">for</span> state<span class="token punctuation">.</span>backlog <span class="token operator"><</span> MaxBacklog <span class="token operator">&&</span> state<span class="token punctuation">.</span>requested <span class="token operator"><</span> pw<span class="token punctuation">.</span>length <span class="token punctuation">{</span><br>                blockSize <span class="token operator">:=</span> MaxBlockSize<br>                <span class="token comment">// Last block might be shorter than the typical block</span><br>                <span class="token keyword">if</span> pw<span class="token punctuation">.</span>length<span class="token operator">-</span>state<span class="token punctuation">.</span>requested <span class="token operator"><</span> blockSize <span class="token punctuation">{</span><br>                    blockSize <span class="token operator">=</span> pw<span class="token punctuation">.</span>length <span class="token operator">-</span> state<span class="token punctuation">.</span>requested<br>                <span class="token punctuation">}</span><br><br>                err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SendRequest</span><span class="token punctuation">(</span>pw<span class="token punctuation">.</span>index<span class="token punctuation">,</span> state<span class="token punctuation">.</span>requested<span class="token punctuation">,</span> blockSize<span class="token punctuation">)</span><br>                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>                    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>                <span class="token punctuation">}</span><br>                state<span class="token punctuation">.</span>backlog<span class="token operator">++</span><br>                state<span class="token punctuation">.</span>requested <span class="token operator">+=</span> blockSize<br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><br><br>        err <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">readMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> state<span class="token punctuation">.</span>buf<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre><h4>main.go</h4><p class=mb-4>This is a short one. We‚Äôre almost there.<pre class=language-go><code class=language-go><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>    <span class="token string">"log"</span><br>    <span class="token string">"os"</span><br><br>    <span class="token string">"github.com/veggiedefender/torrent-client/torrentfile"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    inPath <span class="token operator">:=</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>    outPath <span class="token operator">:=</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><br><br>    tf<span class="token punctuation">,</span> err <span class="token operator">:=</span> torrentfile<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>inPath<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><br>    err <span class="token operator">=</span> tf<span class="token punctuation">.</span><span class="token function">DownloadToFile</span><span class="token punctuation">(</span>outPath<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><script async id=asciicast-xqRSB0Jec8RN91Zt89rbb9PcL src=https://asciinema.org/a/xqRSB0Jec8RN91Zt89rbb9PcL.js></script><h2 class="text-xl sm:text-3xl font-bold mb-2 mt-7" id=this-isn%E2%80%99t-the-full-story tabindex=-1>This isn‚Äôt the full story</h2><p class=mb-4>For brevity, I included only a few of the important snippets of code. Notably, I left out all the glue code, parsing, unit tests, and the boring parts that build character. View my <a class="font-bold underline" href=https://github.com/veggiedefender/torrent-client>full implementation</a> if you‚Äôre interested.</main></div></div><div class="py-6 sm:py-16 border-b border-t text-left sm:text-center bg-white"><div class="max-w-[600px] container"><h1 class="text-3xl sm:text-5xl font-bold">Open Source</h1><p class="text-gray-600 text-sm sm:text-lg leading-relaxed my-2.5 sm:my-5">The project is OpenSource, <a class="font-medium text-gray-600 hover:text-black underline underline-offset-2" href=https://github.com/search?o=desc&q=stars%3A%3E100000&s=stars&type=Repositories target=_blank>6th most starred project on GitHub</a> and is visited by hundreds of thousands of developers every month.<div class="block mb-1.5 sm:mb-0"><a class="inline-flex items-center group rounded-md relative" href=https://github.com/kamranahmedse/developer-roadmap target=_blank> <span class="inline-flex items-center border border-black py-1.5 px-3 rounded-lg text-sm group-hover:text-white group-hover:bg-black relative bg-white"> <div class="mr-1 -ml-1"><svg class="w-4 h-4 fill-current" viewbox="0 0 14 15" focusable=false height=15 width=14 xmlns=http://www.w3.org/2000/svg><path d="M6.99999 11.1515L2.88574 13.4545L3.80449 8.82984L0.342407 5.6285L5.02482 5.07317L6.99999 0.791504L8.97516 5.07317L13.6576 5.6285L10.1955 8.82984L11.1142 13.4545L6.99999 11.1515Z"></path></svg></div> <span class=lowercase>220K</span> <span class="ml-1.5 group-hover:hidden">GitHub Stars</span> <span class="ml-2 hidden group-hover:block">Star us on GitHub</span> </span> </a></div></div></div><div class="py-6 sm:py-16 pb-10 bg-slate-900 text-white"><div class=container><p class="text-gray-400 font-medium flex flex-col sm:flex-row gap-0 sm:gap-4 mb-8 sm:mb-16 justify-center"><a class="transition-colors px-2 py-1.5 border-b border-b-gray-700 sm:border-b-0 sm:py-0 sm:px-0 hover:text-white" href=/roadmaps>Roadmaps</a> <a class="transition-colors px-2 py-1.5 border-b border-b-gray-700 sm:border-b-0 sm:py-0 sm:px-0 hover:text-white" href=/guides>Guides</a> <a class="transition-colors px-2 py-1.5 border-b border-b-gray-700 sm:border-b-0 sm:py-0 sm:px-0 hover:text-white" href=/videos>Videos</a> <a class="transition-colors px-2 py-1.5 border-b border-b-gray-700 sm:border-b-0 sm:py-0 sm:px-0 hover:text-white" href=/about>About</a> <a class="transition-colors px-2 py-1.5 sm:border-b-0 sm:py-0 sm:px-0 hover:text-white" href=https://youtube.com/theroadmap?sub_confirmation=1 target=_blank>YouTube</a><div class="flex flex-col sm:flex-row justify-between gap-12"><div class=max-w-[365px]><p class="flex items-center text-md"><a class="font-medium text-lg inline-flex items-center hover:text-gray-100 text-white transition-colors hover:text-gray-400" href=/> <svg viewbox="0 0 283 283" fill=none height=30 width=30 xmlns=http://www.w3.org/2000/svg><path d="M0 39C0 17.46 17.46 0 39 0h205c21.539 0 39 17.46 39 39v205c0 21.539-17.461 39-39 39H39c-21.54 0-39-17.461-39-39V39Z" fill=currentColor></path><path d="M121.215 210.72c-1.867.56-4.854 1.12-8.96 1.68-3.92.56-8.027.84-12.32.84-4.107 0-7.84-.28-11.2-.84-3.174-.56-5.88-1.68-8.12-3.36-2.24-1.68-4.014-3.92-5.32-6.72-1.12-2.987-1.68-6.813-1.68-11.48v-84c0-4.293.746-7.933 2.24-10.92 1.68-3.173 4.013-5.973 7-8.4 2.986-2.427 6.626-4.573 10.92-6.44 4.48-2.053 9.24-3.827 14.28-5.32a106.176 106.176 0 0 1 15.68-3.36 95.412 95.412 0 0 1 16.24-1.4c8.96 0 16.053 1.773 21.28 5.32 5.226 3.36 7.84 8.96 7.84 16.8 0 2.613-.374 5.227-1.12 7.84-.747 2.427-1.68 4.667-2.8 6.72-3.92 0-7.934.187-12.04.56-4.107.373-8.12.933-12.04 1.68-3.92.747-7.654 1.587-11.2 2.52-3.36.747-6.254 1.68-8.68 2.8v95.48Zm45.172-22.4c0-7.84 2.426-14.373 7.28-19.6 4.853-5.227 11.48-7.84 19.88-7.84 8.4 0 15.026 2.613 19.88 7.84 4.853 5.227 7.28 11.76 7.28 19.6 0 7.84-2.427 14.373-7.28 19.6-4.854 5.227-11.48 7.84-19.88 7.84-8.4 0-15.027-2.613-19.88-7.84-4.854-5.227-7.28-11.76-7.28-19.6Z" fill=#000></path></svg> <span class=ml-2>roadmap.sh</span> </a> <span class="text-gray-400 mx-2">by</span> <a class="bg-blue-600 text-sm py-1 px-1.5 font-regular hover:bg-blue-700 rounded-md" href=https://twitter.com/kamranahmedse target=_blank> <span class="hidden sm:inline">@kamranahmedse</span> <span class="inline sm:hidden">Kamran Ahmed</span> </a><p class="text-slate-300/60 my-4">Community created roadmaps, articles, resources and journeys to help you choose your path and grow in your career.<div class="text-gray-400 text-sm"><p>¬© roadmap.sh <span class=mx-1.5>¬∑</span> <a class=hover:text-white href=/about>FAQs</a> <span class=mx-1.5>¬∑</span> <a class=hover:text-white href=/terms>Terms</a> <span class=mx-1.5>¬∑</span> <a class=hover:text-white href=/privacy>Privacy</a></div></div><div class="text-left sm:text-right max-w-[365px]"><a href=https://thenewstack.io target=_blank> <img class="my-1.5 mr-auto sm:mr-0 sm:ml-auto" alt=ThewNewStack height=24.8 src=/assets/images/tns.png width=200> </a><p class="text-slate-300/60 my-4">The leading DevOps resource for Kubernetes, cloud-native computing, and the latest in at-scale development, deployment, and management.<div class="text-gray-400 text-sm"><p><a class="text-gray-400 hover:text-white" href=https://thenewstack.io/category/devops/ target=_blank>DevOps</a> <span class=mx-1.5>¬∑</span> <a class="text-gray-400 hover:text-white" href=https://thenewstack.io/category/kubernetes/ target=_blank>Kubernetes</a> <span class=mx-1.5>¬∑</span> <a class="text-gray-400 hover:text-white" href=https://thenewstack.io/category/cloud-native/ target=_blank>Cloud-Native</a></div></div></div></div></div><script src=/scripts/navigation.js></script>